name: Einzelne Korrekturansicht

on:
  workflow_dispatch:
    inputs:
      letter_id:
        description: 'Brief-ID im Format L00001'
        required: true
        default: 'L00001'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Validate input format
        run: |
          if [[ ! "${{ github.event.inputs.letter_id }}" =~ ^L[0-9]{5}$ ]]; then
            echo "❌ Ungültiges Format: muss L gefolgt von 5 Ziffern sein (z. B. L00001)"
            exit 1
          fi

      - name: Download XML
        run: |
          curl -f -o "${{ github.event.inputs.letter_id }}.xml" \
            "https://raw.githubusercontent.com/arthur-schnitzler/schnitzler-briefe-arbeit/main/editions/${{ github.event.inputs.letter_id }}.xml"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y texlive-xetex 
    
      - name: Install Saxon (XSLT 2.0 Processor)
        run: |
          sudo apt-get update
          sudo apt-get install -y default-jre
          curl -L -o saxon-he.jar https://repo1.maven.org/maven2/net/sf/saxon/Saxon-HE/12.4/Saxon-HE-12.4.jar

      - name: XSLT Remove Namespaces
        run: |
          xsltproc xslt/einzel-1-remove-namespaces.xsl "${{ github.event.inputs.letter_id }}.xml" > tmp-nons.xml

      - name: XSLT Transform to TeX
        run: |
          xsltproc xslt/einzel-2-Korrekturansicht.xsl tmp-nons.xml > "${{ github.event.inputs.letter_id }}.tex"

      - name: Compile LaTeX (1st run)
        run: xelatex -interaction=nonstopmode "${{ github.event.inputs.letter_id }}.tex"

      - name: Compile LaTeX (2nd run)
        run: xelatex -interaction=nonstopmode "${{ github.event.inputs.letter_id }}.tex"

      - name: Compile LaTeX (3rd run)
        run: xelatex -interaction=nonstopmode "${{ github.event.inputs.letter_id }}.tex"

      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.letter_id }}-pdf
          path: ${{ github.event.inputs.letter_id }}.pdf
          compression-level: 6
          overwrite: true
